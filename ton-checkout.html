<!DOCTYPE html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ TON</title>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f4f9fc;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }
      .payment-container {
        width: 360px;
        background: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        text-align: center;
      }
      h1 {
        margin-bottom: 16px;
      }
      .amount {
        font-size: 1.2em;
        margin-bottom: 20px;
      }
      .connect-wrapper {
        display: flex;
        justify-content: center;
        margin: 20px 0;
      }
      #connect-button .ton-connect-button {
        width: 100%;
        max-width: 280px;
      }
      .ton-button {
        display: block;
        width: 100%;
        max-width: 280px;
        margin: 12px auto;
        padding: 12px;
        font-size: 1em;
        color: #fff;
        background: #0098ea;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .ton-button:hover {
        background: #007ac2;
      }
      .wallet-info {
        text-align: left;
        margin-top: 20px;
        word-break: break-word;
      }
      .wallet-info p {
        margin: 12px 0 6px;
        font-weight: 600;
        font-size: 1.1em;
      }
      .wallet-info span {
        display: block;
        font-family: monospace;
        font-size: 1.1em;
        color: #333;
      }
      .hidden {
        display: none;
      }
      .error {
        color: red;
        margin-top: 12px;
        font-weight: 600;
      }
      /* –ü–æ–¥–ø—Ä–∞–≤–∏–ª —Å—Ç–∏–ª—å –¥–ª—è –±–æ–ª–µ–µ –≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –±–∞–ª–∞–Ω—Å–∞ –∏ –∞–¥—Ä–µ—Å–∞ */
      .wallet-info p {
        margin: 12px 0 6px;
        font-weight: 600;
        font-size: 1.5em;
      }
      .wallet-info span {
        font-family: monospace;
        font-size: 1.5em;
        color: #333;
        word-break: break-word;
      }
    </style>
  </head>
  <body>
    <div class="payment-container">
      <h1>–û–ø–ª–∞—Ç–∏—Ç–∏ –æ–Ω–ª–∞–π–Ω –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è üí≥</h1>
      <p class="amount">–°—É–º–∞ –¥–æ —Å–ø–ª–∞—Ç–∏: <b id="order-summary"></b></p>
      <p class="amount">
        –í —Ç–æ–∫–µ–Ω—ñ TON: <b id="order-summary2">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</b>
      </p>

      <p id="crypto-price">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
      <div class="connect-wrapper">
        <div id="connect-button"></div>
      </div>

      <div id="wallet-info" class="wallet-info hidden">
        <p>üîó –í–∞—à–∞ –∞–¥—Ä–µ—Å–∞ –≥–∞–º–∞–Ω—Ü—è hex/raw::</p>
        <span id="wallet-address">‚Äî</span>
        <p>üí∞ –ë–∞–ª–∞–Ω—Å TON:</p>
        <span id="ton-balance">‚Äî</span>
      </div>

      <button id="pay-button" class="ton-button hidden">–û–ø–ª–∞—Ç–∏—Ç–∏</button>

      <div id="error" class="error"></div>
    </div>

    <script>
      const API_KEY =
        "d3f661b9dcdcc932fb7f369f29f863e8456bacf6cb34bef2ffcc4e8d2ee9439a";
      const PAY_ADDRESS = "UQDQneUBjm3B_SYkv9oxyssnVsqWxJ-fwWXvgzw19O7dtfTk";

      const tonConnect = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl:
          "https://fxckfxck.github.io/sitetest2/tonconnect-manifest.json",
        buttonRootId: "connect-button",
      });

      const infoBlock = document.getElementById("wallet-info");
      const addrElem = document.getElementById("wallet-address");
      const tonElem = document.getElementById("ton-balance");
      const payBtn = document.getElementById("pay-button");
      const errElem = document.getElementById("error");

      async function fetchTonBalance(address) {
        const res = await fetch(
          `https://toncenter.com/api/v2/getAddressBalance?address=${address}&api_key=${API_KEY}`
        );
        const json = await res.json();
        if (!json.ok)
          throw new Error(
            json.error?.message || "–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –±–∞–ª–∞–Ω—Å—É TON"
          );
        const balanceTon = Number(json.result) / 10 ** 9;
        return balanceTon.toFixed(3);
      }

      async function updateWalletInfo() {
        try {
          const wallet = await tonConnect.wallet;
          if (!wallet) return;

          errElem.textContent = "";
          infoBlock.classList.remove("hidden");
          payBtn.classList.remove("hidden");

          const userAddr = wallet.account.address;
          addrElem.textContent = userAddr;

          const ton = await fetchTonBalance(userAddr);
          tonElem.textContent = `${ton} TON`;
        } catch (e) {
          errElem.textContent = e.message;
          console.error(e);
        }
      }

      tonConnect.onStatusChange(updateWalletInfo);
      updateWalletInfo();

      payBtn.addEventListener("click", async () => {
        try {
          // –ë–µ—Ä–µ–º–æ —Ç–µ–∫—Å—Ç, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ "0.0312 TON"
          const tonText = document.getElementById("order-summary2").textContent;
          // –ü–∞—Ä—Å–∏–º–æ —á–∏—Å–ª–æ –∑ —Ä—è–¥–∫–∞ (–±–µ—Ä–µ–º–æ —á–∞—Å—Ç–∏–Ω—É –ø–µ—Ä–µ–¥ –ø—Ä–æ–±—ñ–ª–æ–º)
          const tonAmount = parseFloat(tonText.split(" ")[0]);
          if (isNaN(tonAmount) || tonAmount <= 0) {
            alert("–ù–µ–≤—ñ—Ä–Ω–∞ —Å—É–º–∞ –¥–ª—è –æ–ø–ª–∞—Ç–∏");
            return;
          }

          // –ü–µ—Ä–µ–≤–æ–¥–∏–º–æ –≤ –Ω–∞–Ω–æ—Ç–æ–Ω–∏ (—Ü—ñ–ª–µ —á–∏—Å–ª–æ —É —Ä—è–¥–∫—É)
          const amountNano = (tonAmount * 1e9).toFixed(0);

          await tonConnect.sendTransaction({
            validUntil: Math.floor(Date.now() / 1000) + 60,
            messages: [
              {
                address: PAY_ADDRESS,
                amount: amountNano,
              },
            ],
          });

          alert("‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø—ñ—à–Ω–∞!");
        } catch (e) {
          alert("‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–ø–ª–∞—Ç—ñ");
          console.error(e);
        }
      });

      const totalPrice1 = sessionStorage.getItem("totalPrice");
      const totalQuantity = sessionStorage.getItem("totalQuantity");

      document.getElementById("order-summary").innerHTML = `
      <strong></strong>‚Ç¥${totalPrice1}
    `;

      async function fetchTonPrice() {
        try {
          const res = await fetch(
            "https://api.coingecko.com/api/v3/simple/price?vs_currencies=usd,uah&symbols=TON"
          );
          const data = await res.json();
          const tonPriceUah = data.ton.uah;

          document.getElementById(
            "crypto-price"
          ).textContent = `–ö—É—Ä—Å TON ‚âà ‚Ç¥${tonPriceUah}`;

          if (totalPrice1 && !isNaN(totalPrice1)) {
            const tonAmount = (parseFloat(totalPrice1) / tonPriceUah).toFixed(
              4
            );
            document.getElementById(
              "order-summary2"
            ).textContent = `${tonAmount} TON`;
          } else {
            document.getElementById("order-summary2").textContent =
              "–ü–æ–º–∏–ª–∫–∞ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É";
          }
        } catch (e) {
          document.getElementById("order-summary2").textContent =
            "–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫—É—Ä—Å—É";
          console.error(e);
        }
      }

      fetchTonPrice();
    </script>
  </body>
</html>









